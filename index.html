<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SabLog - ÊôÇÈñìÂ∑Æ„ÉÅ„É£„ÉÉ„Éà</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Lucide Icons („Ç∑„É≥„Éó„É´„Å™SVGÁâà)
        const Calendar = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
        );

        const Clock = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
        );

        const Send = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
        );

        const Settings = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M12 1v6m0 6v6m6-6h6M1 12h6"></path>
            </svg>
        );

        const MessageSquare = () => (
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
        );

        function TimeDelayedChat() {
            const [messages, setMessages] = useState([]);
            const [currentMessage, setCurrentMessage] = useState('');
            const [minDelay, setMinDelay] = useState(5);
            const [maxDelay, setMaxDelay] = useState(30);
            const [waitingForReply, setWaitingForReply] = useState(false);
            const [nextNotificationTime, setNextNotificationTime] = useState(null);
            const [showSettings, setShowSettings] = useState(false);
            const [pendingMessage, setPendingMessage] = useState('');

            useEffect(() => {
                const savedMessages = localStorage.getItem('timeDelayMessages');
                if (savedMessages) {
                    setMessages(JSON.parse(savedMessages));
                }

                const savedSettings = localStorage.getItem('delaySettings');
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    setMinDelay(settings.min);
                    setMaxDelay(settings.max);
                }

                const savedWaiting = localStorage.getItem('waitingForReply');
                const savedNotificationTime = localStorage.getItem('nextNotificationTime');
                const savedPendingMessage = localStorage.getItem('pendingMessage');

                if (savedWaiting === 'true' && savedNotificationTime) {
                    setWaitingForReply(true);
                    setNextNotificationTime(new Date(savedNotificationTime));
                    if (savedPendingMessage) {
                        setPendingMessage(savedPendingMessage);
                    }
                }
            }, []);

            useEffect(() => {
                if (messages.length > 0) {
                    localStorage.setItem('timeDelayMessages', JSON.stringify(messages));
                }
            }, [messages]);

            useEffect(() => {
                localStorage.setItem('delaySettings', JSON.stringify({ min: minDelay, max: maxDelay }));
            }, [minDelay, maxDelay]);

            useEffect(() => {
                if (!waitingForReply || !nextNotificationTime) return;

                const checkNotification = setInterval(() => {
                    if (new Date() >= nextNotificationTime) {
                        triggerNotification();
                        clearInterval(checkNotification);
                    }
                }, 1000);

                return () => clearInterval(checkNotification);
            }, [waitingForReply, nextNotificationTime]);

            const getRandomDelay = () => {
                return Math.floor(Math.random() * (maxDelay - minDelay + 1) + minDelay);
            };

            const triggerNotification = () => {
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification('SabLog', {
                        body: pendingMessage || 'ÈÅéÂéª„ÅÆ„ÅÇ„Å™„Åü„Åã„Çâ„É°„ÉÉ„Çª„Éº„Ç∏„ÅåÂ±ä„Åç„Åæ„Åó„Åü',
                        icon: 'üí¨'
                    });
                }

                setWaitingForReply(false);
                setNextNotificationTime(null);
                setPendingMessage('');
                localStorage.removeItem('waitingForReply');
                localStorage.removeItem('nextNotificationTime');
                localStorage.removeItem('pendingMessage');
            };

            const requestNotificationPermission = async () => {
                if ('Notification' in window && Notification.permission === 'default') {
                    await Notification.requestPermission();
                }
            };

            const sendMessage = () => {
                if (!currentMessage.trim()) return;

                const now = new Date();
                const newMessage = {
                    id: Date.now(),
                    text: currentMessage,
                    timestamp: now.toISOString(),
                    date: now.toLocaleDateString('ja-JP')
                };

                setMessages(prev => [...prev, newMessage]);
                setCurrentMessage('');
                setPendingMessage(currentMessage);

                const delayMinutes = getRandomDelay();
                const notificationTime = new Date(now.getTime() + delayMinutes * 60000);

                setWaitingForReply(true);
                setNextNotificationTime(notificationTime);
                localStorage.setItem('waitingForReply', 'true');
                localStorage.setItem('nextNotificationTime', notificationTime.toISOString());
                localStorage.setItem('pendingMessage', currentMessage);

                requestNotificationPermission();
            };

            const getTimeUntilNotification = () => {
                if (!nextNotificationTime) return '';

                const now = new Date();
                const diff = nextNotificationTime - now;

                if (diff <= 0) return 'ÈÄöÁü•Ê∫ñÂÇô‰∏≠...';

                const minutes = Math.floor(diff / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);

                return `${minutes}ÂàÜ${seconds}ÁßíÂæå`;
            };

            const groupMessagesByDate = () => {
                const grouped = {};
                messages.forEach(msg => {
                    if (!grouped[msg.date]) {
                        grouped[msg.date] = [];
                    }
                    grouped[msg.date].push(msg);
                });
                return grouped;
            };

            const formatTime = (timestamp) => {
                return new Date(timestamp).toLocaleTimeString('ja-JP', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            };

            const groupedMessages = groupMessagesByDate();

            return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 p-4">
                    <div className="max-w-2xl mx-auto">
                        <div className="bg-white rounded-2xl shadow-xl overflow-hidden">
                            <div className="bg-gradient-to-r from-indigo-600 to-purple-600 p-6 text-white">
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center gap-3">
                                        <MessageSquare />
                                        <h1 className="text-2xl font-bold">SabLog</h1>
                                    </div>
                                    <button
                                        onClick={() => setShowSettings(!showSettings)}
                                        className="p-2 hover:bg-white/20 rounded-lg transition"
                                    >
                                        <Settings />
                                    </button>
                                </div>
                                {waitingForReply && (
                                    <div className="mt-4 flex items-center gap-2 text-sm bg-white/20 rounded-lg p-3">
                                        <Clock />
                                        <span>Ê¨°„ÅÆÈÄöÁü•„Åæ„Åß: {getTimeUntilNotification()}</span>
                                    </div>
                                )}
                            </div>

                            {showSettings && (
                                <div className="bg-gray-50 p-6 border-b">
                                    <h3 className="font-semibold mb-4 text-gray-800">ÈÄöÁü•ÈñìÈöî„ÅÆË®≠ÂÆö</h3>
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm text-gray-600 mb-2">
                                                ÊúÄÂ∞èÊôÇÈñì (ÂàÜ): {minDelay}
                                            </label>
                                            <input
                                                type="range"
                                                min="1"
                                                max="120"
                                                value={minDelay}
                                                onChange={(e) => setMinDelay(Math.min(Number(e.target.value), maxDelay))}
                                                className="w-full"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm text-gray-600 mb-2">
                                                ÊúÄÂ§ßÊôÇÈñì (ÂàÜ): {maxDelay}
                                            </label>
                                            <input
                                                type="range"
                                                min="1"
                                                max="120"
                                                value={maxDelay}
                                                onChange={(e) => setMaxDelay(Math.max(Number(e.target.value), minDelay))}
                                                className="w-full"
                                            />
                                        </div>
                                    </div>
                                </div>
                            )}

                            <div className="h-96 overflow-y-auto p-6 space-y-6">
                                {Object.keys(groupedMessages).length === 0 ? (
                                    <div className="h-full flex items-center justify-center text-gray-400">
                                        <div className="text-center">
                                            <div className="mx-auto mb-3 opacity-50">
                                                <Calendar />
                                            </div>
                                            <p>„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°„Åó„Å¶ÂØæË©±„ÇíÂßã„ÇÅ„Åæ„Åó„Çá„ÅÜ</p>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="space-y-6">
                                        {Object.entries(groupedMessages).reverse().map(([date, msgs]) => (
                                            <div key={date}>
                                                <div className="flex items-center gap-2 mb-3">
                                                    <div className="h-px bg-gray-200 flex-1"></div>
                                                    <span className="text-xs text-gray-500 font-medium">{date}</span>
                                                    <div className="h-px bg-gray-200 flex-1"></div>
                                                </div>
                                                {msgs.map((msg) => (
                                                    <div key={msg.id} className="mb-3">
                                                        <div className="bg-indigo-600 text-white rounded-2xl rounded-br-sm px-4 py-3 inline-block max-w-[80%]">
                                                            <p>{msg.text}</p>
                                                            <p className="text-xs text-indigo-200 mt-1">
                                                                {formatTime(msg.timestamp)}
                                                            </p>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            <div className="border-t p-4 bg-gray-50">
                                <div className="flex gap-2">
                                    <input
                                        type="text"
                                        value={currentMessage}
                                        onChange={(e) => setCurrentMessage(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && !waitingForReply && sendMessage()}
                                        placeholder="Êú™Êù•„ÅÆËá™ÂàÜ„Å∏„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ„Çã..."
                                        className="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                        disabled={waitingForReply}
                                    />
                                    <button
                                        onClick={sendMessage}
                                        disabled={waitingForReply || !currentMessage.trim()}
                                        className="bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition"
                                    >
                                        <Send />
                                    </button>
                                </div>
                                {waitingForReply && (
                                    <p className="text-sm text-gray-500 mt-2 text-center">
                                        Ëøî‰ø°„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇÈÄöÁü•„ÅåÂ±ä„Åè„Åæ„Åß„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ
                                    </p>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<TimeDelayedChat />, document.getElementById('root'));
    </script>
</body>
</html>
